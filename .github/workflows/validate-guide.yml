name: Validate Guide

on:
  pull_request:
    branches: [main]
    paths:
      - '**.md'

jobs:
  validate:
    name: Validate Frontmatter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate Guide Frontmatter
        run: |
          echo "Validating guide frontmatter..."

          # Find all changed markdown files
          ERRORS=0

          for file in $(find . -maxdepth 1 -name "*.md" -type f ! -name "README.md"); do
            echo "Checking $file..."
            
            # Check if file starts with ---
            if ! head -1 "$file" | grep -q "^---$"; then
              echo "❌ $file: Missing frontmatter (must start with ---)"
              ERRORS=$((ERRORS + 1))
              continue
            fi
            
            # Extract frontmatter
            FRONTMATTER=$(sed -n '1,/^---$/p' "$file" | tail -n +2 | head -n -1)
            
            # Check required fields
            if ! echo "$FRONTMATTER" | grep -q "^title:"; then
              echo "❌ $file: Missing required field 'title'"
              ERRORS=$((ERRORS + 1))
            fi
            
            if ! echo "$FRONTMATTER" | grep -q "^description:"; then
              echo "❌ $file: Missing required field 'description'"
              ERRORS=$((ERRORS + 1))
            fi
            
            if ! echo "$FRONTMATTER" | grep -q "^category:"; then
              echo "❌ $file: Missing required field 'category'"
              ERRORS=$((ERRORS + 1))
            fi
            
            if ! echo "$FRONTMATTER" | grep -q "^author:"; then
              echo "❌ $file: Missing required field 'author'"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Validate category is one of allowed values
            CATEGORY=$(echo "$FRONTMATTER" | grep "^category:" | sed 's/category:\s*//')
            VALID_CATEGORIES="Beginner Advanced Reference General"
            if ! echo "$VALID_CATEGORIES" | grep -qw "$CATEGORY"; then
              echo "⚠️  $file: Category '$CATEGORY' is not standard (Beginner, Advanced, Reference, General)"
            fi
            
            # Check if heroImage file exists (if specified)
            HERO=$(echo "$FRONTMATTER" | grep "^heroImage:" | sed 's/heroImage:\s*//')
            if [ -n "$HERO" ] && [ ! -f "$HERO" ]; then
              echo "❌ $file: heroImage '$HERO' not found"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Validate nextGuide/prevGuide references exist
            NEXT=$(echo "$FRONTMATTER" | grep "^nextGuide:" | sed 's/nextGuide:\s*//')
            if [ -n "$NEXT" ] && [ ! -f "${NEXT}.md" ]; then
              echo "❌ $file: nextGuide '${NEXT}' does not exist (${NEXT}.md not found)"
              ERRORS=$((ERRORS + 1))
            fi
            
            PREV=$(echo "$FRONTMATTER" | grep "^prevGuide:" | sed 's/prevGuide:\s*//')
            if [ -n "$PREV" ] && [ ! -f "${PREV}.md" ]; then
              echo "❌ $file: prevGuide '${PREV}' does not exist (${PREV}.md not found)"
              ERRORS=$((ERRORS + 1))
            fi
            
            if [ $ERRORS -eq 0 ]; then
              echo "✅ $file: Valid"
            fi
          done

          echo ""
          if [ $ERRORS -gt 0 ]; then
            echo "❌ Validation failed with $ERRORS error(s)"
            exit 1
          else
            echo "✅ All guides validated successfully!"
          fi
