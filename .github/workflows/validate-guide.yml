name: Validate Guide

on:
  pull_request:
    branches: [main]
    paths:
      - '**.md'

jobs:
  validate:
    name: Validate Frontmatter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Files
        id: changed
        run: |
          # Get list of changed .md files (excluding README)
          FILES=$(git diff --name-only origin/main HEAD -- '*.md' | grep -v README.md || true)
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $FILES"

      - name: Validate Guide Frontmatter
        run: |
          echo "Validating guide frontmatter..."

          ERRORS=0
          CHANGED_FILES="${{ steps.changed.outputs.files }}"

          # If no markdown files changed, skip validation
          if [ -z "$CHANGED_FILES" ]; then
            echo "✅ No guide files changed, skipping validation"
            exit 0
          fi

          for file in $CHANGED_FILES; do
            # Skip if file doesn't exist (was deleted)
            if [ ! -f "$file" ]; then
              echo "⏭️  $file was deleted, skipping"
              continue
            fi
            
            echo "Checking $file..."
            
            # Normalize line endings and check frontmatter
            CONTENT=$(cat "$file" | tr -d '\r')
            FIRST_LINE=$(echo "$CONTENT" | head -1)
            
            if [ "$FIRST_LINE" != "---" ]; then
              echo "❌ $file: Missing frontmatter (must start with ---)"
              ERRORS=$((ERRORS + 1))
              continue
            fi
            
            # Extract frontmatter (between first and second ---)
            FRONTMATTER=$(echo "$CONTENT" | sed -n '2,/^---$/p' | head -n -1)
            
            # Check required fields
            if ! echo "$FRONTMATTER" | grep -q "^title:"; then
              echo "❌ $file: Missing required field 'title'"
              ERRORS=$((ERRORS + 1))
            fi
            
            if ! echo "$FRONTMATTER" | grep -q "^description:"; then
              echo "❌ $file: Missing required field 'description'"
              ERRORS=$((ERRORS + 1))
            fi
            
            if ! echo "$FRONTMATTER" | grep -q "^category:"; then
              echo "❌ $file: Missing required field 'category'"
              ERRORS=$((ERRORS + 1))
            fi
            
            if ! echo "$FRONTMATTER" | grep -q "^author:"; then
              echo "❌ $file: Missing required field 'author'"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Check if heroImage file exists (if specified)
            HERO=$(echo "$FRONTMATTER" | grep "^heroImage:" | sed 's/heroImage:\s*//')
            if [ -n "$HERO" ] && [ ! -f "$HERO" ]; then
              echo "❌ $file: heroImage '$HERO' not found"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Validate nextGuide/prevGuide references exist
            NEXT=$(echo "$FRONTMATTER" | grep "^nextGuide:" | sed 's/nextGuide:\s*//')
            if [ -n "$NEXT" ] && [ ! -f "${NEXT}.md" ]; then
              echo "❌ $file: nextGuide '${NEXT}' does not exist (${NEXT}.md not found)"
              ERRORS=$((ERRORS + 1))
            fi
            
            PREV=$(echo "$FRONTMATTER" | grep "^prevGuide:" | sed 's/prevGuide:\s*//')
            if [ -n "$PREV" ] && [ ! -f "${PREV}.md" ]; then
              echo "❌ $file: prevGuide '${PREV}' does not exist (${PREV}.md not found)"
              ERRORS=$((ERRORS + 1))
            fi
            
            echo "✅ $file: Valid"
          done

          echo ""
          if [ $ERRORS -gt 0 ]; then
            echo "❌ Validation failed with $ERRORS error(s)"
            exit 1
          else
            echo "✅ All changed guides validated successfully!"
          fi
